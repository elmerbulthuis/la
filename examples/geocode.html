<!DOCTYPE html>
<html>
<head>

<title>geocode</title>
<script type="text/javascript" src="../jam/require.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>

</head>

<body>

<form id="search">
<input type="text" class="search" autocomplete="off" />
<input type="text" class="search" autocomplete="off" />
<input type="text" class="search" autocomplete="off" />
</form>

<ul id="found">
</ul>

<script type="text/javascript">
require.config({
	baseUrl: ".."
});

require(['lib/la'], function(la){

	var geocoder = new google.maps.Geocoder();
	var timeoutHandle = 0;

	var search = new la.ValueFuture(decodeURIComponent((location.hash || '#').substring(1)));
	search.bind(function(value){
		var searchElement = document.getElementById('search');
		var elements = searchElement.elements;
		var elementCount = elements.length;
		for(var elementIndex = 0; elementIndex < elementCount; elementIndex++){
			var element = elements[elementIndex];
			element.value = value;
		}
	});
	search.bind(function(value){
		location.replace('#' + encodeURIComponent(value));
	});

	var found = new la.DependencyFuture(search, function(search, cb){
		timeoutHandle = setTimeout(function(){
			geocoder.geocode({
				address: search	
			}, function(results, status){
				cb(results)
			});		
		}, 1000);
	});
	found.on('cancel', function(){
		clearTimeout(timeoutHandle);
	});

	found.bind(function(value){
		var foundElement = document.getElementById('found');
		while(foundElement.firstChild) foundElement.removeChild(foundElement.firstChild);
		
		value
		&& value
		.map(function(item){
			var itemElement = document.createElement('li');
			itemElement.appendChild(document.createTextNode(item.formatted_address));
			return itemElement
		})
		.forEach(function(element){
			foundElement.appendChild(element);
		})
		;
	});

	document.addEventListener('keyup', function(e){
		if(e.target.className == 'search'){
			search.set(e.target.value);
		}
	}, false);

});
</script>


</body>
</html>
